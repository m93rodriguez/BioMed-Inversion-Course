\documentclass[a4paper]{article} 

\input{../../doc_config}

\def \flux {\phi}
\def \mua {\mu_{a}}
\def \p {\mathbf p}

\title{\LARGE \bf
	Numerical methods for the forward Diffusion Approximation
}
\author{Martin Rodriguez-Vega}

%\pagecolor[HTML]{192129} % dark color
%\color[HTML]{cccccc} % light color


\begin{document}
	
\maketitle
\thispagestyle{empty}
\pagestyle{empty}

\section{Preface}

In this document, we will develop numerical schemes for solving the Diffusion Approximation (DA)
\begin{equation}\label{eq-da}
	-\nabla \cdot D(\r) \nabla \flux(\r) + \mua(\r)\flux(\r) = s(\r)
\end{equation}
where $\r$ is a point in some domain $\Omega$, $\flux$ [W/m$^2$] is the fluence or energy flux, $\mua$ [m$^{-1}$] is the absorption coefficient, $D$ [m] is the diffusion coefficient, and $s$ is a source term. 

As this is intended as an introductory primer, we will initially restrict out analysis to the Simplified DA, which assumes the diffusion coefficient is homogeneous in space, so \eqref{eq-da} becomes
\begin{equation}\label{eq-sda}
	-\nabla^2 \flux + k(\r)^2\flux = \frac{s(\r)}{D}
\end{equation}
where $k^2 = \mua / D$ (the squared is a convention commonly used in the literature and in the study of differential equations). Furthermore, we will consider the two dimensional case and a slab geometry \textit{i.e.} $\Omega = [0, L_x] \times [0, L_y]$, using a uniform rectangular discretization. However, hints will be included on how to generalize.

It is expected that the reader is proficient with vector calculus and linear algebra.

\section{Finite Element Method}

The Finite Element Method (FEM) consists on approximating the solution using piece-wise polynomial functions on a discretized mesh. An element is a region of the domain defined by a collection of vertices as shown in Fig.~\ref{fig-elements}.
%
\begin{figure}
	\centering
	\begin{tikzpicture}[scale=2.5, xscale=1.5]
		
		\tikzstyle{P} = [draw, circle, fill, scale=0.5]
		\tikzstyle{l} = [node distance = 0.5cm]
		
		\node[P] at (-1,-1) (p0) {};\node[below right of = p0, l] {$v_0$};
		\node[P] at (-1,0) (p1) {}; \node[below right of = p1, l] {$v_1$};
		\node[P] at (-1,1) (p2) {}; \node[below right of = p2, l] {$v_2$};
		\node[P] at (0,-1) (p3) {}; \node[below right of = p3, l] {$v_3$};
		\node[P] at (0,0) (p4) {};  \node[below right of = p4, l] {$v_4$};
		\node[P] at (0,1) (p5) {};  \node[below right of = p5, l] {$v_5$};
		\node[P] at (1,-1) (p6) {}; \node[below right of = p6, l] {$v_6$};
		\node[P] at (1,0) (p7) {};  \node[below right of = p7, l] {$v_7$};
		\node[P] at (1,1) (p8) {};  \node[below right of = p8, l] {$v_8$};
		
		\draw (p0) -- (p1) -- (p2) -- (p5) -- (p8) -- (p7) -- (p6) -- (p3) -- (p0);
		\draw (p3) -- (p4) -- (p1);
		\draw (p5) -- (p4) -- (p7);
		
		\node at (-0.5, -0.5) {$\mathcal E_0$};
		\node at (-0.5, 0.5) {$\mathcal E_1$};
		\node at (0.5, -0.5) {$\mathcal E_2$};
		\node at (0.5, 0.5) {$\mathcal E_3$};
	\end{tikzpicture}
	\caption{Simple mesh consisting of 9 vertices and 4 elements.}
	\label{fig-elements}
\end{figure}
%
For each vertex $i$ there is a basis function $\psi_i(\r)$ which is (usually) polynomial inside each element and continuous across boundaries. 

For instance, the basis function associated with vertex 4 in the figure is
\begin{equation}
	\psi_4(x,y) = \left\{\begin{array}{ccl}
		(1-x)(1-y) & \text{if} & (x,y) \in [-1,0]^2 \\
		(1-x)(1+y) & \text{if} & (x,y) \in [-1,0]\times[0,1] \\
		(1+x)(1-y) & \text{if} & (x,y) \in [0,1]\times[-1,0] \\
		(1+x)(1+y) & \text{if} & (x,y) \in [0,1]^2 \\		
	\end{array}\right.
\end{equation}
assuming the grid covers $[-1,1]^2$.
This are the quadrilateral degree 1 basis function, and is a biliear function.

We want to approximate
\begin{equation}
	\flux(\r) = \sum_i \flux_i \psi_i(\r)
\end{equation}
where $\flux_i$ are weights that have to be determined. Note that by the form of basis functions that we chose, $\psi_i(\r)$ is 1 at the position of $v_i$ and 0 for any other vertex, so $\flux_i$ is simply the value of the function at $v_i$.

In general, the elements used to define the basis functions are not squares of side length 1. To use the same definition, we introduce the normalized coordinates $\p$ such that $\psi_i(\p)$ is defined as before, and there is an (invertible) mapping $\xi: \R^2 \rightarrow \R^2$ such that $\r = \xi(\p)$
Thus
\begin{equation}
	\psi_i(\r) = \psi_i(\xi(\p))
\end{equation}
For general quadrilaterals with points vertices located at $\r_0, \r_1, \r_2, \r_3$,
we have
\begin{equation}
	\xi(\p) = \sum_{i=0}^3 \psi_i(\p) \r_i
\end{equation}
inside each element.
When the grid is regular consisting of parallelograms, $\xi$ is a linear function: $\xi(\p) = \Xi\p$ where $\Xi$ is a $2\times 2$ matrix. In the simple case of rectangular grids
\begin{equation}
	\Xi = \left[\begin{array}{cc}
		\Delta x & 0 \\ 0 & \Delta y
	\end{array}
	\right]
\end{equation}

Now, to analyze \eqref{eq-sda}, we introduce the concept of weak formulation. The idea behind this, is that numerical methods are better behaved when dealing with integrals than derivatives, even more so when they are of higher order. The weak form of a differential equation is obtained by multiplying it by a ``well-behaved'' (in the sense that it is bounded, continuous and differentiable in a given domain) test function $w(\r)$ and then we integrate over $\Omega$:
%
\begin{equation}
	-\int_\Omega w(\r)\nabla^2 \flux(\r) \dif^2 \r + \int_\Omega k(\r)^2w(\r)\flux(\r)\dif^2 \r = \int_\Omega w(\r)\frac{s(\r)}{D} \dif^2 \r
\end{equation}
and using Green's first identity
\begin{equation}
	\int_\Omega \nabla w \cdot \nabla \flux \dif^2 \r 
	-\int_{\partial\Omega} w \pdifx[\n]{\flux} \dif\r 
	+ \int_\Omega k^2w\flux\dif^2 \r 
	= \int_\Omega w\frac{s}{D} \dif^2 \r
\end{equation}
The interest of the weak formulation is that we were able to ``move''  one of the derivatives of the Laplacian to the test function. The second term encodes boundary conditions. For instance, if we use homogeneous Dirichlet conditions, \textit{i.e.} $\flux(\r) = 0$ for $\r\in \partial\Omega$, we can force the test function to satisfy them as well, so
\begin{equation}
	\int_\Omega \nabla w \cdot \nabla \flux \dif^2 \r 
	+ \int_\Omega k^2w\flux\dif^2 \r 
	= \int_\Omega \frac{s}{D} \dif^2 \r
\end{equation}

Expanding the approximation of $\flux(\r)$ using the basis functions:
\begin{equation}
	\sum_i  \flux_i \int_\Omega \nabla w \cdot \nabla\psi_i \dif^2 \r 
	+ \sum_i\flux_i\int_\Omega k^2w  \psi_i\dif^2 \r 
	= \int_\Omega w\frac{s}{D} \dif^2 \r
\end{equation}
This has to satisfied for any test function $w$, so we choose for simplicity one of the basis functions $\psi_i$, so
\begin{equation}
	\sum_i  \flux_i \int_\Omega \nabla \psi_j(\r) \cdot \nabla\psi_i(\r) \dif^2 \r 
	+ \sum_i\flux_i\int_\Omega k(\r)^2 \psi_j(\r)  \psi_i(\r)\dif^2 \r 
	= \int_\Omega \psi_j(\r)\frac{s}{D} \dif^2 \r
\end{equation}

To apply the change of coordinates, we denote the Jacobian matrix as $J_\xi(\p) = \partial \xi / \partial \p$. Furthermore, we use the numerator layout for matrix calculus, so gradients are row vectors. With this, the change of coordinates for the gradient is
\begin{equation}
	\nabla \psi(\r) = \nabla_\p \psi(\p) J_{\inv{\xi}}(\r)  = \nabla_\p \psi(\p) \inv J_\xi(\p)
\end{equation}
where the last term uses the Inverse Function Theorem.

\begin{align}\begin{split}
	&\sum_i  \flux_i \int_\Omega 
	\nabla_\p \psi_j(\p) \inv{J_\xi}(\p)
	J_\xi^{-\top}(\p) \nabla^\top_\p\psi_i(\p) \left| \det J_\xi(\p) \right|\dif^2 \p \\
	+& \sum_i\flux_i\int_\Omega k^2(\p) \psi_j(\p)  \psi_i(\p)\left| \det J_\xi(\p) \right|\dif^2 \p \\
	=& \int_\Omega \psi_j(\p)\frac{s(\p)}{D} \left| \det J_\xi(\p) \right|\dif^2 \p
\end{split}\end{align}

As we have chosen the basis functions to be compact, only few of the pairs $(i,j)$ will have non-zero terms in the summation. Geometrically, this can be seen as the vertices $i$, $j$ which share at least one element. Furthermore, inside each element, the functions are polynomial, and we assume as simplification that $k^2$ is piece-wise constant. Let $\mathcal E_i^j$ be the set of elements that have both vertices $i$ and $j$. Then,

\begin{align}\begin{split}
		&\sum_i  \flux_i \sum_{\mathcal E \in \mathcal E_i^j} \int_\mathcal{E}
		\nabla_\p \psi_j(\p) \inv{J_\xi}(\p)
		J_\xi^{-\top}(\p) \nabla^\top_\p\psi_i(\p) \left| \det J_\xi(\p) \right|\dif^2 \p \\
		+& \sum_i\flux_i\sum_{\mathcal E \in \mathcal E_i^j} k^2_\mathcal E \int_\mathcal{E}\psi_j(\p)  \psi_i(\p)\left| \det J_\xi(\p) \right|\dif^2 \p \\
		=& \int_\Omega \psi_j(\p)\frac{s(\p)}{D} \left| \det J_\xi(\p) \right|\dif^2 \p
\end{split}\end{align}

We introduce back the simplifying assumption that the physical grid consists of regular squares with side lengths $\Delta x$, so $J_\epsilon = \Delta x \mathbb I$. Thus

\begin{align}\begin{split}
		&\sum_i  \flux_i \sum_{\mathcal E \in \mathcal E_i^j} \int_\mathcal{E}
		\nabla_\p \psi_j \nabla^\top_\p\psi_i\dif^2 \p 
		+ \Delta x^2\sum_i\flux_i\sum_{\mathcal E \in \mathcal E_i^j} k^2_\mathcal E \int_\mathcal{E}\psi_j  \psi_i\dif^2 \p \\
		=& \Delta x^2\int_\Omega \psi_j\frac{s}{D} \dif^2 \p
\end{split}\end{align}

To evaluate the integrals, we can use the symmetry of mesh. First, note that the basis functions are the product between two identical functions of a single variable. Moreover, for each element we can shift and rotate the coordinates as needed, so that
\begin{equation}
	\psi(x,y) = \nu(x)\nu(y) \quad , \quad \nu(x) = 1 - x \quad , \quad x, y \in [0, 1]
\end{equation}
and for any other vertex of the same element, the basis function is obtained by using $\nu(1-x) = x$ for one or both terms as needed. Therefore, the only integrals required are
\begin{align}\begin{split}
	\int_0^1 \nu(x)^2\dif x = \frac{1}{3} \hspace{1cm} & \int_0^1 \nu(x)\nu(1-x)\dif x = \frac{1}{6} \\
	\int_0^1 \nu'(x)^2\dif x = 1 \hspace{1cm} & \int_0^1 \nu'(x)\nu'(1-x)\dif x = -1 
\end{split}\end{align}

Thus, 
\begin{align}
	\int_\mathcal{E} \psi_i \psi_j \dif^2 \p = \int_0^1 \nu_i(x) \nu_j(x)\dif x  \int_0^1 \nu_i(y) \nu_j(y)\dif y \\ 
	\int_\mathcal{E} \nabla \psi_i \cdot \nabla \psi_j \dif^2 \p = \int_0^1 \nu'_i(x) \nu'_j(x)\dif x \int_0^1 \nu_i(y) \nu_j(y)\dif y + \int_0^1 \nu_i(x) \nu_j(x)\dif x \int_0^1 \nu'_i(y) \nu'_j(y)\dif y
\end{align}

There are three types of non-zero interactions between vertices $i$, $j$:  
\begin{enumerate}
	\item $i=j$ which yields 4 elements and $\nu_i(x) = \nu_j(x)$ (same for $y$), so
	\begin{align}
		\int_\mathcal{E} \psi_i \psi_j \dif^2 \p = \frac{1}{9} \\
		\int_\mathcal{E} \nabla \psi_i \cdot \nabla \psi_j \dif^2 \p = \frac{2}{3}
	\end{align}
	
	\item $i$ and $j$ are orthogonally adjacent yielding 2 elements, $\nu_i(x) = \nu_j(1-x)$ and $\nu_i(y) = \nu_j(y)$ (or vice-versa)
	\begin{align}
		\int_\mathcal{E} \psi_i \psi_j \dif^2 \p = \frac{1}{18} \\
		\int_\mathcal{E} \nabla \psi_i \cdot \nabla \psi_j \dif^2 \p = -\frac{1}{6}
	\end{align}

	\item $i$ and $j$ are  diagonally adjacent which yields 1 element and $\nu_i(x) = \nu_j(1-x)$ (same for $y$), so
	\begin{align}
		\int_\mathcal{E} \psi_i \psi_j \dif^2 \p = \frac{1}{36} \\
		\int_\mathcal{E} \nabla \psi_i \cdot \nabla \psi_j \dif^2 \p = -\frac{1}{3}
	\end{align}
\end{enumerate}
For each vertex, there is one vertex of type 1 (itself), four of type 2, and four of type 3.

\end{document}